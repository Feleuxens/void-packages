# Template file for 'PWAsForFirefox'
pkgname=PWAsForFirefox
version=2.8.0
revision=1
archs="~*-musl"
build_style=cargo
hostmakedepends="pkg-config"
makedepends="openssl-devel"
depends="firefox"
short_desc="Native part of the firefox extension PWAsForFirefox"
maintainer="Feleuxens <me@feleuxens.de>"
license="MPL-2.0"
homepage="https://github.com/filips123/PWAsForFirefox"
distfiles="https://github.com/filips123/PWAsForFirefox/archive/refs/tags/v${version}.tar.gz"
checksum=d2aff50d963d9d197b41f8736d9fbc3a01922f455d7b90eae1ce80dab3d9f313

post_extract() {
	# rm everything except native/
	find . -mindepth 1 -maxdepth 1 -not -name native -exec rm -r '{}' \;
	# move everything inside native to root
	mv native/* .
	# set version because it is set to 0.0.0
	vsed -i "s/0.0.0/${version}/" Cargo.toml
	vsed -i "/firefoxpwa/,/0.0.0/ s/0.0.0/${version}/" Cargo.lock
	vsed -i "s/DISTRIBUTION_VERSION = '0.0.0'/DISTRIBUTION_VERSION = '${version}'/g" userchrome/profile/chrome/pwa/chrome.jsm
}

post_install() {
	vinstall "target/${RUST_TARGET}/release/firefoxpwa-connector" 755 usr/libexec
	vinstall manifests/linux.json 644 usr/lib/mozilla/native-messaging-hosts firefoxpwa.json
	vinstall manifests/linux.json 644 usr/lib64/mozilla/native-messaging-hosts firefoxpwa.json

	vmkdir usr/share/firefoxpwa/userchrome/
	vcopy userchrome/* usr/share/firefoxpwa/userchrome/
}
